<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AZ Motor Spare Delivery - Data</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #2c2c2c;
      color: #fff;
      margin: 0;
      padding: 20px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
    }
    th, td {
      padding: 10px;
      text-align: left;
      border: 1px solid #444;
    }
    th {
      background-color: #b30000;
    }
    .progress-container {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .progress-bar {
      position: relative;
      height: 10px;
      width: 120px;
      background: #ddd;
      border-radius: 5px;
      overflow: hidden;
    }

    .progress-bar div {
      height: 100%;
      background: #007bff;
      transition: width 0.3s ease-in-out;
    }

    .progress-bar.green div {
      background: linear-gradient(90deg, #4caf50, #66bb6a);
    }

    .progress-percent {
      font-size: 0.9rem;
      font-weight: bold;
      min-width: 35px;
      text-align: center;
    }

    input[type="range"] {
      -webkit-appearance: none;
      width: 150px;
      height: 8px;
      background: #ddd;
      border-radius: 5px;
      outline: none;
      cursor: pointer;
    }

    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 18px;
      height: 18px;
      background: #007bff;
      border-radius: 50%;
      cursor: pointer;
    }

    input[type="range"]::-moz-range-thumb {
      width: 18px;
      height: 18px;
      background: #007bff;
      border-radius: 50%;
      cursor: pointer;
    }

    .delete-btn {
      background-color: #ff4d4d;
      border: none;
      color: white;
      padding: 5px 10px;
      border-radius: 5px;
      cursor: pointer;
    }

    .delete-btn:hover {
      background-color: #e63939;
    }
  </style>
</head>
<body>
  <h2>AZ Motor Spare Delivery - Data</h2>
  <table id="dataTable">
    <thead>
      <tr>
        <th>Date</th>
        <th>Customer Name</th>
        <th>Contact</th>
        <th>Location</th>
        <th>Progress</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <script src="https://www.gstatic.com/firebasejs/7.20.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/7.20.0/firebase-database.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAmy836Pc3NBJfqv7ovKeLuXEroEKKljes",
      authDomain: "delivery-d07af.firebaseapp.com",
      databaseURL: "https://delivery-d07af-default-rtdb.firebaseio.com",
      projectId: "delivery-d07af",
      storageBucket: "delivery-d07af.appspot.com",
      messagingSenderId: "18177223806",
      appId: "1:18177223806:web:e09f3abf45b6d25fc2fc2f",
      measurementId: "G-V7TC88WW4L",
    };
    firebase.initializeApp(firebaseConfig);

const database = firebase.database();
const tableBody = document.querySelector('#dataTable tbody');
let activeIntervals = {};  // Store active intervals for progress updates

// Listen for changes to the 'deliveries' data in Firebase and update the table
database.ref('deliveries').on('value', (snapshot) => {
  tableBody.innerHTML = '';
  snapshot.forEach((childSnapshot) => {
    const data = childSnapshot.val();
    const progressBarClass = data.progress === 100 ? 'green' : '';

    // Create the table row with delivery information
    const row = `
      <tr data-id="${childSnapshot.key}">
        <td>${data.date}</td>
        <td>${data.customerName}</td>
        <td>${data.contact}</td>
        <td>${data.location}</td>
        <td>
          <div class="progress-container">
            <div class="progress-bar ${progressBarClass}">
              <div style="width: ${data.progress}%"></div>
            </div>
            <span class="progress-percent">${data.progress}%</span>
            <input type="range" min="0" max="100" value="${data.progress}" data-id="${childSnapshot.key}" class="progress-slider">
            <input type="number" min="1" placeholder="Enter minutes" class="time-input" data-id="${childSnapshot.key}">
          </div>
        </td>
        <td>
          <button class="delete-btn" data-id="${childSnapshot.key}">Delete</button>
        </td>
      </tr>
    `;
    tableBody.innerHTML += row;

    // Resume progress if the start time exists
    const id = childSnapshot.key;
    if (data.startTime) {
      let progress = data.progress;
      let timeInSeconds = data.timeInSeconds;
      let startTime = data.startTime;

      let elapsedTime = (Date.now() - startTime) / 1000; // elapsed time in seconds
      if (elapsedTime < timeInSeconds) {
        progress = (elapsedTime / timeInSeconds) * 100;
      } else {
        progress = 100;
      }

      // Update progress bar UI
      const row = document.querySelector(`tr[data-id='${id}']`);
      const progressBar = row.querySelector('.progress-bar div');
      const progressPercent = row.querySelector('.progress-percent');
      const rangeInput = row.querySelector('.progress-slider');

      progressBar.style.width = `${progress}%`;
      progressPercent.textContent = `${Math.round(progress)}%`;
      rangeInput.value = Math.round(progress);

      // Start the interval for real-time updates if progress is not 100%
      if (progress < 100 && !activeIntervals[id]) {
        activeIntervals[id] = setInterval(() => {
          let currentTime = Date.now();
          let elapsedTime = (currentTime - startTime) / 1000; // elapsed time in seconds
          progress = (elapsedTime / timeInSeconds) * 100;

          if (progress >= 100) {
            progress = 100;
            clearInterval(activeIntervals[id]); // Stop once it reaches 100%
            delete activeIntervals[id]; // Remove from active intervals
          }

          // Update UI
          const progressBar = row.querySelector('.progress-bar div');
          const progressPercent = row.querySelector('.progress-percent');
          const rangeInput = row.querySelector('.progress-slider');

          progressBar.style.width = `${progress}%`;
          progressPercent.textContent = `${Math.round(progress)}%`;
          rangeInput.value = Math.round(progress);

          // Update Firebase with the current progress
          database.ref(`deliveries/${id}`).update({ progress: Math.round(progress) });

        }, 1000); // Update every second
      }
    }
  });
});

// Handle time input changes to start or update progress
document.addEventListener('change', (e) => {
  if (e.target.classList.contains('time-input')) {
    const id = e.target.dataset.id;
    let timeInMinutes = parseFloat(e.target.value);

    if (isNaN(timeInMinutes) || timeInMinutes < 1) {
      alert("Please enter a valid number of minutes.");
      return;
    }

    let timeInSeconds = timeInMinutes * 60;
    let progress = 0;
    let startTime = Date.now();
    let endTime = startTime + timeInSeconds * 1000;

    let row = e.target.closest('tr');

    // Store start time and initial progress in Firebase
    database.ref(`deliveries/${id}`).update({
      startTime: startTime,
      progress: progress,
      timeInSeconds: timeInSeconds
    });

    // Start updating progress
    let interval = setInterval(() => {
      let currentTime = Date.now();
      let elapsedTime = (currentTime - startTime) / 1000; // elapsed time in seconds
      progress = (elapsedTime / timeInSeconds) * 100;

      if (progress >= 100) {
        progress = 100;
        clearInterval(interval); // Stop once it reaches 100%
      }

      // Update UI
      const progressBar = row.querySelector('.progress-bar div');
      const progressPercent = row.querySelector('.progress-percent');
      const rangeInput = row.querySelector('.progress-slider');

      progressBar.style.width = `${progress}%`;
      progressPercent.textContent = `${Math.round(progress)}%`;
      rangeInput.value = Math.round(progress);

      // Update Firebase with the current progress
      database.ref(`deliveries/${id}`).update({ progress: Math.round(progress) });

    }, 1000); // Update every second
  }
});

// Handle delete button click to remove delivery data
document.addEventListener('click', (e) => {
  if (e.target.classList.contains('delete-btn')) {
    const id = e.target.dataset.id;
    clearInterval(activeIntervals[id]); // Clear the active interval before deletion
    delete activeIntervals[id];
    database.ref(`deliveries/${id}`).remove();
  }
});

// Clear any active intervals on page unload to avoid memory leaks
window.addEventListener('beforeunload', () => {
  for (const id in activeIntervals) {
    clearInterval(activeIntervals[id]);
  }
});

  </script>
</body>
</html>
